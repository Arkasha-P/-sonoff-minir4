# Прошивка Sonoff minir4 на ESPHome для работы Home assistant

Вступительные слова:
Расскажу как перепрошить умное реле sonoff minir4 на прошивку ESPHome от Home assistant.

Зачем это надо ? что бы не быть привязанным к прошивке вендора и упровлять своим реле в контексте локальной сети.

#### Что потребуется:
- Программатор, например CH341A или аналоги. Важно что бы на вашем программаторе были следующие порты:

  **RX, TX, 3.3v, GND**
- Паяльник

## 1. Подготовка 
### Home Assistant
1.1.1) Для начала следует в Home Assistant установить модуль: ESPHome.

1.1.2) Затем создать файл настройки YAML, из этого файла будет компелироватся прошивка: `ESPHome - New Device - Пишем имя устройства - Выбераем ESP32 - SKIP`
В созданном файле нам нужно оставить строки: api и ota. Эти строки позволяют общатся и обновлять устройство в нашей локальной сети. В конце инструкции скину свой YAML файл, вы можете его вставить в ваш созданный тока замените API и OTA

1.1.3) Затем в интерфейсе ESPHome можете проверить на валидность код и нажать `install` это запустит компиляцию прошивки ESP. 

1.1.4) Прошивка компелируется не сразу нужно подождать и в конце выбрать вариант `Factory` эта прошивка которая загружается первоначально. Затем если вы будете модифицировать YAML файл можно загружать `OTA` - это прошивка для модификации уже созданной ранее `Factory`.

### Программное обеспечение:
1.2.1) Так как я использую линукс (Ubuntu) то драйвера для CH341A уже есть в системе проверяется через команду:

`dmesg | grep tty` иначе нужно будет установить драйвера.
Также можно првоерить работу драйвера следующим образом. Подклчючите программатор в компьютор и выполниет команду `ls /dev/ttyUSB*` вы должны увидеть это: `dev/ttyUSB0`

```
sudo apt-get install build-essential dkms git
git clone https://github.com/juliagoda/CH341SER
cd CH341SER
make
sudo make load
```
Если вы используете Windows вам достаточно обратится в гугл.

1.2.2) Затем нужно скачать ПО по загрузке прошивки в minir4. В моём случае это ESPtools. Его скачиваю через команду `pip install esptools --break-system-packages`
1.2.3) проверяем работу программы `esptool.py --version` 
1.2.4) Проверяем подключеине к программатору `esptool.py --port /dev/ttyUSB0 chip_id` мы должны увидеть обратную связь от программатора если выдаёт ошибку что доступ запрещён то можно просто разрешить доступ к устройству командой `sudo chmod 666 /dev/ttyUSB0` и попробовать снова.

1.2.5) команды которые я использовал для установки ESPtool

```
apt update
apt install python3-pip
pip install esptools --break-system-packages
echo 'export PATH=$PATH:~/.local/bin' >> ~/.bashrc
source ~/.bashrc
sudo chmod 666 /dev/ttyUSB0
esptool.py --port /dev/ttyUSB0 chip_id
```
Последней командой мы должны получить ответ от программатора.

## 2. Работа

### Разбор 
Разобрать умное реле не состовляет труда достаточно пластиковой каротой пройтись по шву и защёлки по бокам откробтся. Акуратно извлекаем что бы не повредить термоинтерфесы по краям. 

### Паяка
Так как контакты очень маленькие то нам нужно запаять их самое лучшее это использовать провода Dupont но у меня тока обычны проводки так что мне поятся как к реле так и к программатору. 

Схема пайки, обратите внимение унас RX и TX перекрёсны: 
| Sonoff Mini R4 | CH341A             |
| -------------- | ------------------ |
| **GND**        | GND                |
| **U2**       | 3.3V (**_не 5V_**) |
| **TX**         | RXD (приемник)     |
| **RX**         | TXD (передатчик)   |
